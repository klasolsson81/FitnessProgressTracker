# .github/workflows/discord-notifications.yml
name: Discord Notiser

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

  workflow_run:
    workflows: [".NET Build and Test"]
    types:
      - completed

jobs:
  notify_pr:
    name: Skicka PR Notis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Skicka Discord-notis om ny PR
        uses: actions/github-script@v7
        with:
          script: |
            const webhookURL = process.env.DISCORD_WEBHOOK;
            const payload = {
              content: "üôã‚Äç‚ôÄÔ∏è Ny Pull Request! Dags att granska!",
              embeds: [
                {
                  title: `${{ github.event.pull_request.title }} (#${{ github.event.pull_request.number }})`,
                  description: `Fr√•n: **${{ github.actor }}**\nGren: \`${{ github.event.pull_request.head.ref }}\``,
                  url: "${{ github.event.pull_request.html_url }}",
                  color: 16766720
                }
              ]
            };
            
            await fetch(webhookURL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload)
            });
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

  notify_build_status:
    name: Skicka Byggstatus
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    
    steps:
      - name: Skicka notis om byggstatus
        uses: actions/github-script@v7
        with:
          script: |
            const webhookURL = process.env.DISCORD_WEBHOOK;
            const conclusion = "${{ github.event.workflow_run.conclusion }}";
            
            let content, color, title;
            
            if (conclusion === 'success') {
              content = "‚úÖ Bygge lyckades!";
              color = 3066993;
              title = "Workflow `.NET Build and Test` lyckades";
            } else if (conclusion === 'failure') {
              content = "üö® **BYGGE MISSLYCKADES** üö®";
              color = 15158332;
              title = "Workflow `.NET Build and Test` misslyckades";
            } else {
              // Om det √§r cancelled, skipped, etc.
              return;
            }
            
            const payload = {
              content: content,
              embeds: [
                {
                  title: title,
                  description: `K√∂rdes p√• grenen \`${{ github.event.workflow_run.head_branch }}\` av **${{ github.actor }}**.${conclusion === 'failure' ? ' \n**V√§nligen kolla loggarna!**' : ''}`,
                  url: "${{ github.event.workflow_run.html_url }}",
                  color: color
                }
              ]
            };
            
            await fetch(webhookURL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload)
            });
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
