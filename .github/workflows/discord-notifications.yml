# .github/workflows/discord-notifications.yml
name: Discord Notiser

on:
  # Trigger 1: N√§r en Pull Request √∂ppnas, √•ter√∂ppnas eller markeras som "redo f√∂r review"
  pull_request:
    types: [opened, reopened, ready_for_review]

  # Trigger 2: N√§r ett annat workflow √§r f√§rdigt
  # Denna "lyssnar" p√• ert huvud-workflow (f√∂r bygge/test)
  workflow_run:
    # ‚ùóÔ∏è VIKTIGT: Byt ut "Bygg och Testa" mot det exakta 'name:' fr√•n er andra .yml-fil (t.ex. build.yml)
    workflows: [".NET Build and Test"] 
    types:
      - completed # K√∂rs n√§r det andra workflown √§r helt klart

jobs:
  # Jobb 1: Hanterar notiser f√∂r Pull Requests
  notify_pr:
    name: Skicka PR Notis
    runs-on: ubuntu-latest
    # K√∂r bara detta jobb om triggern var en 'pull_request'
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Skicka Discord-notis om ny PR
        # Anv√§nder en popul√§r och enkel action f√∂r detta
        uses: Ilshidur/action-discord@0.3.0
        env:
          # H√§mtar er webhook fr√•n GitHub Secrets
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            {
              "content": "üôã‚Äç‚ôÄÔ∏è Ny Pull Request! Dags att granska!",
              "embeds": [
                {
                  "title": "${{ github.event.pull_request.title }} (#${{ github.event.pull_request.number }})",
                  "description": "Fr√•n: **${{ github.actor }}**\nGren: `${{ github.event.pull_request.head.ref }}`",
                  "url": "${{ github.event.pull_request.html_url }}",
                  "color": 16766720
                }
              ]
            }

  # Jobb 2: Hanterar notiser f√∂r bygge/test-status
  notify_build_status:
    name: Skicka Byggstatus
    runs-on: ubuntu-latest
    # K√∂r bara detta jobb om triggern var 'workflow_run'
    if: github.event_name == 'workflow_run'
    
    steps:
      # Steg 2a: K√∂rs ENDAST om bygget lyckades (success)
      - name: Skicka notis om lyckat bygge
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        uses: Ilshidur/action-discord@0.3.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            {
              "content": "‚úÖ Bygge lyckades!",
              "embeds": [
                {
                  "title": "Workflow `${{ github.event.workflow_run.name }}` lyckades",
                  "description": "K√∂rdes p√• grenen `${{ github.event.workflow_run.head_branch }}` av **${{ github.actor }}**.",
                  "url": "${{ github.event.workflow_run.html_url }}",
                  "color": 3066993
                }
              ]
            }

      # Steg 2b: K√∂rs ENDAST om bygget misslyckades (failure)
      - name: Skicka notis om misslyckat bygge
        if: ${{ github.event.workflow_run.conclusion == 'failure' }}
        uses: Ilshidur/action-discord@0.3.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            {
              "content": "üö® **BYGGE MISSLYCKADES** üö®",
              "embeds": [
                {
                  "title": "Workflow `${{ github.event.workflow_run.name }}` misslyckades",
                  "description": "K√∂rdes p√• grenen `${{ github.event.workflow_run.head_branch }}` av **${{ github.actor }}**. \n**V√§nligen kolla loggarna!**",
                  "url": "${{ github.event.workflow_run.html_url }}",
                  "color": 15158332
                }
              ]
            }
